<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>OROM/SVG</title>
    <style>
    svg circle:hover {
      fill: lightgreen;
    }
    svg line {
      stroke-width: 2;
      stroke-opacity: 1;
      pointer-events: none;
      visibility: hidden;
    }
    svg line.arrow {
      pointer-events: none;
      visibility: visible;
    }
    svg rect {
      stroke: white;
      stroke-width: 2;
      shape-rendering: crispEdges;
    }
    textarea {
      background: lightgray;
    }
    svg foreignObject {
      pointer-events: none;
    }
    textarea {
      pointer-events: all;
      font-size: 16px;
      font-family: 'Courier New';
    }
    </style>
  </head>
  <body>
    <svg>
      <g id="box-1" class="root" transform="translate(0,0)" clip-path="url(#clip-20)">
        <g id="next-id">70</g>
        <rect fill="black" x="0" y="0" width="1389.96" height="963.27" id="rect-19" style="stroke-width: 2px;"></rect>
        <text font-family="Arial Narrow" x="5" y="20" fill="white">root</text>
        <g id="box-2" class="vtable-vtable" transform="translate(21,54)" clip-path="url(#clip-22)">
          <rect fill="grey" height="338" width="503" id="rect-21" style=""></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">vtable-vtable</text>
          <g id="box-3" class="vtable" transform="translate(11,45)" clip-path="url(#clip-24)">
            <rect fill="grey" height="46" width="229" id="rect-23"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">vtable</text>
            <g transform="translate(203,27)">
              <circle r="10" fill="white" stroke="black" id="circle-13">circle-14</circle>
            </g>
            <clipPath id="clip-24"><use href="#rect-23"></use></clipPath>
          </g>
          <g id="box-4" class="parent" transform="translate(254,48)" clip-path="url(#clip-26)">
            <rect fill="grey" height="40" width="181" id="rect-25"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">parent</text>
            <g transform="translate(158,25)">
              <circle r="10" fill="white" stroke="black" id="circle-1">circle-2</circle>
            </g>
            <clipPath id="clip-26"><use href="#rect-25"></use></clipPath>
          </g>
          <g id="box-5" class="methods" transform="translate(13,103)" clip-path="url(#clip-28)">
            <rect fill="grey" height="224" width="479" id="rect-27" style=""></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">methods</text>
            <g id="box-6" class="add-method" transform="translate(10,32)" clip-path="url(#clip-30)">
              <rect fill="grey" height="179" width="459" id="rect-29" style=""></rect>
              <text font-family="Arial Narrow" x="5" y="20" fill="white">add-method</text>
              <foreignObject x="5" y="30" width="100%" height="100%">
                <textarea style="width: 440px; height: 134px;">(rcv, name, code) =&gt; {
  let methods = path_lookup(rcv, 'methods');
  let box = path_lookup(methods, name);
  if (box === undefined)
    box = append_new_box(methods, name);
  else box = svg_userData(box);
  let ta = box.svg.textarea;
  ta.value = ta.textContent = code;
}</textarea>
              </foreignObject>
              <clipPath id="clip-30"><use href="#rect-29"></use></clipPath>
            </g>
            <clipPath id="clip-28"><use href="#rect-27"></use></clipPath>
          </g>
          <circle id="circle-12" cx="440" cy="79"></circle>
          <circle id="circle-14" cx="234" cy="81"></circle>
          <clipPath id="clip-22"><use href="#rect-21"></use></clipPath>
        </g>
        <g id="box-8" class="object-vtable" transform="translate(538,14)" clip-path="url(#clip-8)">
          <clipPath id="clip-8"><use href="#rect-8"></use></clipPath>
          <rect id="rect-8" fill="grey" height="180" width="357" style=""></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">object-vtable</text>
          <g id="box-9" class="vtable" transform="translate(7,30)" clip-path="url(#clip-32)">
            <rect fill="grey" height="69" width="112" id="rect-31"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">vtable</text>
            <g transform="translate(82,46)">
              <circle r="10" fill="white" stroke="black" id="circle-11">circle-12</circle>
            </g>
            <clipPath id="clip-32"><use href="#rect-31"></use></clipPath>
          </g>
          <g id="box-10" class="parent" transform="translate(128,32)" clip-path="url(#clip-34)">
            <rect fill="grey" height="66" width="74" id="rect-33"></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">parent</text>
            <clipPath id="clip-34"><use href="#rect-33"></use></clipPath>
          </g>
          <circle id="circle-2" cx="561" cy="131"></circle>
          <g id="box-18" class="methods" transform="translate(9,132)" clip-path="url(#clip-36)">
            <rect fill="grey" height="38" width="338" id="rect-35" style=""></rect>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">methods</text>
            <clipPath id="clip-36"><use href="#rect-35"></use></clipPath>
          </g>
        </g>
        <g class="init" transform="translate(902,59)" clip-path="url(#clip-38)">
          <rect fill="grey" height="793" width="427" id="rect-37" style=""></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">init</text>
          <foreignObject x="5" y="30" width="100%" height="100%">
            <textarea style="width: 408px; height: 750px; font-family: 'Arial Narrow'; font-size: 15px;">() =&gt; {
vtable_vtable = path_lookup('vtable-vtable');
vtable_addMethod = get_func(vtable_vtable, 'methods', 'add-method');
object_vtable = follow_arrow(path_lookup(vtable_vtable, 'parent'));

vtable_addMethod(vtable_vtable, 'lookup', `(rcv, name) =&gt; {
  let box = path_lookup(rcv, 'methods', name);
  if (box) {
    let src = svg_userData(box).svg.textarea.value;
    return compile(src);
  } else {
    let par = follow_arrow(path_lookup(rcv, 'parent'));
    return par
      ? orom.send(par, 'lookup', name)
      : undefined;
  }
}`);

vtable_lookup = get_func(vtable_vtable, 'methods', 'lookup');

orom = {}; // IMPORTANT...!
orom.send = get_func('send');
orom.bind = get_func('bind');

alert("We've added 'lookup' to all vtables...");

orom.send(object_vtable, 'add-method', 'say-hello', `(rcv) =&gt; {
  console.log("Hello, World! From "+attr(rcv, 'class'));
}`);

alert("We've added 'say-hello' to all objects...");

orom.send(object_vtable, 'say-hello');

console.log('Init finished');
}</textarea>
          </foreignObject>
          <clipPath id="clip-38"><use href="#rect-37"></use></clipPath>
        </g>
        <g class="send" transform="translate(509,494)" clip-path="url(#clip-40)">
          <rect fill="grey" height="122" width="385" id="rect-39" style=""></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">send</text>
          <foreignObject x="5" y="30" width="100%" height="100%">
            <textarea style="width: 367px; height: 80px;">(rcv, selector, ...args) =&gt; {
  let impl = orom.bind(rcv, selector);
  return impl(rcv, ...args);
}</textarea>
          </foreignObject>
          <clipPath id="clip-40"><use href="#rect-39"></use></clipPath>
        </g>
        <g class="bind" transform="translate(400,629)" clip-path="url(#clip-42)">
          <rect fill="grey" height="257" width="495" id="rect-41" style=""></rect>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">bind</text>
          <foreignObject x="5" y="30" width="100%" height="100%">
            <textarea style="width: 475px; height: 213px;">(rcv, selector) =&gt; {
  if (rcv === vtable_vtable
      &amp;&amp; selector === 'lookup') {
    return vtable_lookup(rcv, selector);
  } else {
    let vtable = follow_arrow(
      path_lookup(rcv, 'vtable')
    );
    return orom.send(vtable, 'lookup', selector);
  }
}</textarea>
          </foreignObject>
          <clipPath id="clip-42"><use href="#rect-41"></use></clipPath>
        </g>
        <clipPath id="clip-20"><use href="#rect-19"></use></clipPath>
      </g>
    </svg>
    <script src="orom-svg.js"></script>
    <script type="text/javascript">
      //get_func('init')();
    </script>
  </body>
</html>
