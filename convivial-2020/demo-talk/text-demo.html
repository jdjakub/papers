<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>OROM/SVG</title>
    <style>
    svg circle:hover {
      fill: lightgreen;
    }
    svg line {
      stroke-width: 2;
      stroke-opacity: 1;
      pointer-events: none;
      visibility: hidden;
    }
    svg line.arrow {
      pointer-events: none;
      visibility: visible;
    }
    svg rect {
      stroke: white;
      stroke-width: 2;
      shape-rendering: crispEdges;
    }
    textarea {
      background: lightgray;
    }
    svg foreignObject {
      pointer-events: none;
    }
    textarea {
      pointer-events: all;
      font-size: 16px;
      font-family: 'Courier New';
    }
    </style>
  </head>
  <body>
    <svg>
      <g id="box-1" class="root" transform="translate(0,0)" clip-path="url(#clip-20)">
        <g id="next-id">109</g>
        <rect fill="black" x="0" y="0" width="1389.96" height="963.27" id="rect-19" style=""></rect>
        <text font-family="Arial Narrow" x="5" y="20" fill="white">root</text>
        <clipPath id="clip-20"><use href="#rect-19"></use></clipPath>
        <g id="box-43" clip-path="url(#clip-45)" class="text-layout" transform="translate(195,109)">
          <rect fill="grey" id="rect-44" style="" height="504" width="437"></rect>
          <clipPath id="clip-45"><use href="#rect-44"></use></clipPath>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">text-layout</text>
          <g id="box-46" clip-path="url(#clip-48)" class="controls" transform="translate(12,38)">
            <rect fill="grey" id="rect-47" style="" height="201" width="164"></rect>
            <clipPath id="clip-48"><use href="#rect-47"></use></clipPath>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">controls</text>
            <g id="box-52" clip-path="url(#clip-54)" class="word-1" transform="translate(18,40)">
              <rect fill="grey" id="rect-53" style="" height="33" width="53"></rect>
              <clipPath id="clip-54"><use href="#rect-53"></use></clipPath>
              <text font-family="Arial Narrow" x="5" y="20" fill="white">word-1</text>
            </g>
            <g id="box-55" clip-path="url(#clip-57)" class="word-2" transform="translate(79,41)">
              <rect fill="grey" id="rect-56" style="" height="31" width="54"></rect>
              <clipPath id="clip-57"><use href="#rect-56"></use></clipPath>
              <text font-family="Arial Narrow" x="5" y="20" fill="white">word-2</text>
            </g>
            <g id="box-58" clip-path="url(#clip-60)" class="new-line" transform="translate(17,80)">
              <rect fill="grey" id="rect-59" style="" height="34" width="133"></rect><clipPath id="clip-60"><use href="#rect-59"></use></clipPath>
              <text font-family="Arial Narrow" x="5" y="20" fill="white">new-line</text>
            </g>
          </g>
          <g id="box-49" clip-path="url(#clip-51)" class="demo" transform="translate(14,247)">
            <rect fill="grey" id="rect-50" style="" height="248" width="415"></rect>
            <clipPath id="clip-51"><use href="#rect-50"></use></clipPath>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">demo</text>
          <g id="box-70" clip-path="url(#clip-72)" class="The" transform="translate(18,40)"><rect fill="grey" id="rect-71" style="" height="29" width="33.61666679382324"></rect><clipPath id="clip-72"><use href="#rect-71"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">The</text></g><g id="box-73" clip-path="url(#clip-75)" class="quick" transform="translate(59.61666679382324,40)"><rect fill="grey" id="rect-74" style="" height="29" width="41.650001525878906"></rect><clipPath id="clip-75"><use href="#rect-74"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">quick</text></g><g id="box-76" clip-path="url(#clip-78)" class="brown" transform="translate(109.26666831970215,40)"><rect fill="grey" id="rect-77" style="" height="29" width="46.733333587646484"></rect><clipPath id="clip-78"><use href="#rect-77"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">brown</text></g><g id="box-79" clip-path="url(#clip-81)" class="fox" transform="translate(164.00000190734863,40)"><rect fill="grey" id="rect-80" style="" height="29" width="28.516666412353516"></rect><clipPath id="clip-81"><use href="#rect-80"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">fox</text></g><g id="box-82" clip-path="url(#clip-84)" class="jumped" transform="translate(200.51666831970215,40)"><rect fill="grey" id="rect-83" style="" height="29" width="54.04999923706055"></rect><clipPath id="clip-84"><use href="#rect-83"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">jumped</text></g><g id="box-85" clip-path="url(#clip-87)" class="over" transform="translate(262.5666675567627,40)"><rect fill="grey" id="rect-86" style="" height="29" width="36.53333282470703"></rect><clipPath id="clip-87"><use href="#rect-86"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">over</text></g><g id="box-88" clip-path="url(#clip-90)" class="the" transform="translate(307.1000003814697,40)"><rect fill="grey" id="rect-89" style="" height="29" width="29.25"></rect><clipPath id="clip-90"><use href="#rect-89"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">the</text></g><g id="box-91" clip-path="url(#clip-93)" class="lazy" transform="translate(344.3500003814697,40)"><rect fill="grey" id="rect-92" style="" height="29" width="34.35000038146973"></rect><clipPath id="clip-93"><use href="#rect-92"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">lazy</text></g><g id="box-97" clip-path="url(#clip-99)" class="dog" transform="translate(18,80)"><rect fill="grey" id="rect-98" style="" height="29" width="32.89999961853027"></rect><clipPath id="clip-99"><use href="#rect-98"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">dog</text></g><g id="box-100" clip-path="url(#clip-102)" class="blah" transform="translate(58.89999961853027,80)"><rect fill="grey" id="rect-101" style="" height="29" width="35.816667556762695"></rect><clipPath id="clip-102"><use href="#rect-101"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">blah</text></g><g id="box-103" clip-path="url(#clip-105)" class="blah" transform="translate(102.71666717529297,80)"><rect fill="grey" id="rect-104" style="" height="29" width="35.816667556762695"></rect><clipPath id="clip-105"><use href="#rect-104"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">blah</text></g><g id="box-106" clip-path="url(#clip-108)" class="blah" transform="translate(146.53333473205566,80)"><rect fill="grey" id="rect-107" style="" height="29" width="35.816667556762695"></rect><clipPath id="clip-108"><use href="#rect-107"></use></clipPath><text font-family="Arial Narrow" x="5" y="20" fill="white">blah</text></g></g>
          <g id="box-61" clip-path="url(#clip-63)" class="text-source" transform="translate(190,41)">
            <rect fill="grey" id="rect-62" style="" height="193" width="237"></rect>
            <clipPath id="clip-63"><use href="#rect-62"></use></clipPath>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">text-source</text>
            <foreignObject x="5" y="30" width="100%" height="100%"><textarea style="width: 220px; height: 151px;">The quick  brown fox jumped over the lazy dog</textarea></foreignObject>
          </g>
        </g>
        <g id="box-64" clip-path="url(#clip-66)" class="code" transform="translate(651,36)">
          <rect fill="grey" id="rect-65" style="stroke-width: 2px;" height="706" width="789"></rect>
          <clipPath id="clip-66"><use href="#rect-65"></use></clipPath>
          <text font-family="Arial Narrow" x="5" y="20" fill="white">code</text>
          <foreignObject x="5" y="30" width="100%" height="100%"><textarea style="width: 769px; height: 661px;">() =&gt; {
layout_text = () =&gt; {
  let boxes = {
    text_container: path_lookup('text-layout', 'demo'),
    layout_ctls: path_lookup('text-layout', 'controls'),
    first_word: path_lookup('text-layout', 'controls', 'word-1'),
    second_word: path_lookup('text-layout', 'controls', 'word-2'),
    new_line: path_lookup('text-layout', 'controls', 'new-line'),
    text_source: path_lookup('text-layout', 'text-source'),
  };
  let ctls = {}, top_left = {}, top_right = {}, bot_left = {}, bot_right = {};
  Object.entries(boxes).forEach(([box_name, box]) =&gt; {
    ctls[box_name] = create.rect_controls();
    change(user_data(svg_userData(box).svg.rect).controls, ctls[box_name]);
    top_left[box_name] = poll(ctls[box_name].top_left.position);
    top_right[box_name] = poll(ctls[box_name].top_right.position);
    bot_left[box_name] = poll(ctls[box_name].bot_left.position);
    bot_right[box_name] = poll(ctls[box_name].bot_right.position);
  });

  top_left.initial_relative = vsub(top_left.first_word, top_left.layout_ctls);
  top_left.initial_absolute = vadd(top_left.text_container, top_left.initial_relative);

  let params = {
    inter_word_space: vsub(top_left.second_word, top_right.first_word),
    inter_line_space: vsub(top_left.new_line, top_left.first_word),
  };

  // clear existing work
  boxes.text_container.querySelectorAll('g').forEach(n =&gt; n.remove());

  // Layout afresh
  svg_parent = boxes.text_container;

  place_word = (string) =&gt; {
    let ctls = create.rect_controls();
    let parent = svg_parent;
      let word = create.box();
      change(user_data(word.svg.rect).controls, ctls);
      root_change(ctls.top_left.position, top_left.next_word);
      change(word.key_name, string);
      bb = bbox(word.svg.text);
      org = vadd(poll(ctls.top_left.position), [5,5]);
      root_change(ctls.bot_right.position, vadd(org, props(bb, 'r', 'b')));
    svg_parent = parent;
    change(user_data(word.svg.rect).controls, undefined);
    if (!params.first_of_line &amp;&amp;
      poll(ctls.bot_right.position)[0] &gt; bot_right.text_container[0]) {
      word.svg.group.remove(); // oops
      top_left.curr_line = vadd(top_left.curr_line, [0,params.inter_line_space[1]]);
      top_left.next_word = top_left.curr_line;
      params.first_of_line = true;
      return place_word(string); // try again at new line
    } else {
      top_left.next_word = vadd(
        poll(ctls.top_right.position), [params.inter_word_space[0], 0]
      );
      params.first_of_line = false;
    }
  }

  let words = svg_userData(boxes.text_source).svg.textarea.value
              .split(" ").filter(w =&gt; w.length !== 0);

  top_left.next_word = top_left.initial_absolute;
  top_left.curr_line = top_left.initial_absolute;

  params.first_of_line = true;

  for (let word of words)
    place_word(word);

  Object.values(boxes).forEach(box =&gt;
    change(user_data(svg_userData(box).svg.rect).controls, undefined)
  );
}
}</textarea></foreignObject>
          <g id="box-67" clip-path="url(#clip-69)" class="execute" transform="translate(410,8)">
            <rect fill="grey" id="rect-68" style="" height="73" width="354"></rect>
            <clipPath id="clip-69"><use href="#rect-68"></use></clipPath>
            <text font-family="Arial Narrow" x="5" y="20" fill="white">execute</text>
            <foreignObject x="5" y="30" width="100%" height="100%"><textarea style="width: 326px; height: 28px;">() =&gt; {layout_text();}</textarea></foreignObject>
          </g>
        </g>
      </g>
    </svg>
    <script src="orom-svg.js"></script>
    <script type="text/javascript">
      layout_text();
    </script>
  </body>
</html>
